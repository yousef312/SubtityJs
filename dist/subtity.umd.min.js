!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t="undefined"!=typeof globalThis?globalThis:t||self).Subtity=e()}(this,(function(){"use strict";var e=["0","1","2","3","4","5","6","7","8","9"];function i(){this.subs=[],this.title="",this.text="",this.subtitles=[],this.ranges=[],this.current=0,this.subtitlesCounts=null,this.offset=0,this.style={family:"Arial",size:19,style:"normal",lineSpacing:5,variant:"normal",color:"rgb(255,255,255)",align:"center",direction:"ltr",outlineColor:"rgb(0,0,0)",outlineSize:1,shadowColor:"rgba(0,0,0,0)",opacity:1,shadowBlur:0,shadowX:0,shadowY:0,base:90,left:50,weight:""},this.renderer=null,this.container=null,this.meta={},this.mode=null,this.video=null,this.ctx=document.createElement("canvas").getContext("2d"),this.activated=!1,this.currentFileType=null,this.speedFactor=1}return i.prototype={reset:function(){this.current=0,this.speedFactor=1,this.offset=0,this.style={family:"Arial",size:19,style:"normal",variant:"normal",lineSpacing:10,color:"rgb(255,255,255)",align:"center",direction:"ltr",outlineColor:"rgb(0,0,0)",outlineSize:1,shadowColor:"rgba(0,0,0,0)",shadowBlur:0,opacity:1,shadowX:0,shadowY:0,base:90,left:50,weight:""},this.subtitles=[],this.ranges=[],this.activated=!1,this.subtitlesCounts=0,this.meta={},this.title="",this.currentFileType=null},use:function(t){var e=this.subs.findIndex((e=>e.title===t));if(-1!==e){if(""!==this.title){var s=this.subs.findIndex((t=>t.title===this.title));this.subs[s].used=!1}this.current=0,this.reset(),this.subs[e].used=!0,this.title=this.subs[e].title,this.ranges=this.subs[e].ranges,this.subtitles=this.subs[e].subtitles,this.text=this.subs[e].text,this.subtitlesCounts=this.subs[e].count,this.activated=!0,this.meta=this.subs[e].meta,this.currentFileType=this.subs[e].type,this.calcFontHeight()}},parseSRT:function(t,e,s){var i=t.split("\n"),n={movie:s,title:e,ranges:[],meta:{},subtitles:[],text:t,count:0,type:"srt"},l=!1,a=[];for(let t=0;t<i.length;t++){const e=i[t];1!=e.length&&0!==e.length||0===a.length||(l=!1,n.subtitles.push(a),a=[]),-1!==e.indexOf("--\x3e")?(n.ranges.push(this.getSeconds(e)),l=!0):!0===l&&1!==e.length&&a.push(e)}n.count=n.subtitles.length,this.subs.push(n)},parseXMLBased:function(t,e,s){var i=t.split("<body>")[1].split("</body>")[0].split("</div>"),n={movie:s,title:e,meta:{langs:{}},ranges:[],subtitles:[],text:t,type:"dfxp"},l=null,a=null,r=null,o=null;for(let t=0;t<i.length;t++){const e=i[t].split("<div ")[1];if(void 0!==e){var h=e.substr(0,e.indexOf(">")).split(" ");h.forEach(((t,e)=>{h[e]=h[e].split("="),"xml:lang"===h[e][0]&&(l=h[e][1].replaceAll('"',""),null===r&&(r=l),n.meta.langs[l]=[])}));var u=e.split("</p>");null===l&&(l="en",null===r&&(r=l));for(let e=0;e<u.length;e++){var p=u[e].split("<p ")[1];void 0!==p&&(p=p.substr(p.indexOf(">")+1,p.length),0===t&&(a=p.substr(0,p.indexOf(">")).split(" "),o=[],a.forEach(((t,e)=>{a[e]=a[e].split("="),"begin"===a[e][0]?o[0]=this.convertToTime(a[e][1].replaceAll('"',"")):"end"===a[e][0]&&(o[1]=this.convertToTime(a[e][1].replaceAll('"',"")))}))),n.ranges.push(o),n.meta.langs[l].push(p.split("<br />")))}}}n.subtitles=n.meta.langs[r],n.count=n.subtitles.length,this.subs.push(n)},parseXML:function(t,e,s){var i=t.split("<video>")[1].split("<video/>")[0].split("</title>"),n={movie:s,title:e,meta:{},ranges:[],subtitles:[],text:t,type:"xml"};i.pop();for(let t=0;t<i.length;t++){const e=i[t].split("<title>")[1];rang0=this.convertToTime(e.split("<start>")[1].split("</start>")[0].replace(";",".")),rang1=this.convertToTime(e.split("<end>")[1].split("</end>")[0].replace(";",".")),rang=[rang0,rang1],n.ranges.push(rang),subtitle=e.split("<text>")[1].split("</text>")[0].split("<br/>"),n.subtitles.push(subtitle)}n.count=n.subtitles.length,this.subs.push(n)},parseWEBVTT:function(t,e,s){var i=t.split("\n"),n=!1,l={movie:s,title:e,meta:{},ranges:[],subtitles:[],text:t,type:"webvtt"},a=[];for(let t=0;t<i.length;t++){const e=i[t];if(-1===e.indexOf("NOTE ")&&-1===e[0].indexOf("NOTE\n"))if(!n||1===e.length&&0===e.length||a.push(e),-1!==e.indexOf("--\x3e")){var r=this.getSeconds(e);l.ranges.push(r),n=!0}else 1!==e.length&&0!==e.length||!0!==n||(n=!1,l.subtitles.push(a),a=[])}l.count=l.subtitles.length,this.subs.push(l)},parseSBV:function(t,e,s){var i=t.split("\n"),n=!1,l=!1,a=-1,r={movie:s,title:e,meta:{},ranges:[],subtitles:[],text:t,type:"sbv"};1!==i[0].length&&0!==i[0].length||(n=!0);for(let t=0;t<i.length;t++){var o=i[t];!0===l&&1!==o.length&&0!==o.length&&r.subtitles[a].push(o),!0===n&&(r.ranges.push(this.getSeconds(o)),n=!1,l=!0,a++,r.subtitles[a]=[]),1!==o.length&&0!==o.length||(n=!0,l=!1)}r.count=r.subtitles.length,this.subs.push(r)},parseSSA:function(t,e,s){var i=t.split("\n"),n=null,l=null,a={movie:s,title:e,meta:{},ranges:[],subtitles:[],count:null,text:t,type:"ssa"};for(let t=0;t<i.length;t++){const e=i[t];if("["===e[0])l=e.substr(1,e.indexOf("]")-1).toLowerCase();else if("events"===l){var r=e.split(":");if(r.length>2){for(let t=2;t<r.length;t++)r[1]+=":"+r[t];r.splice(2,r.length)}var o=r[0].toLowerCase(),h=r[1];if("format"===o)n=h.toLowerCase().split(",");else if("dialogue"===o){var u=h.split(",");k=n.findIndex((t=>"text"===t.trim()));var p=u[k];i0=n.findIndex((t=>"start"===t.toLowerCase().trim())),i1=n.findIndex((t=>"end"===t.toLowerCase().trim())),t1=this.convertToTime(u[i0]),t2=this.convertToTime(u[i1]),a.ranges.push([t1,t2]),a.subtitles.push([p])}}else if("script info"===l){if(";"===e[0])continue;o=(r=e.split(":"))[0],a.meta[o]=r[1]}}a.count=a.subtitles.length,this.subs.push(a)},parseRT:function(t,e,s){var i=t.split("<br/>"),n=[],l={movie:s,title:e,meta:{},ranges:[],subtitles:[],count:null,text:t,type:"rt"};i.shift(),i[i.length-1]=i[i.length-1].split("</font>")[0];for(let t=0;t<i.length;t++){n=i[t].split("<clear/>"),rang=n[0].split("<time ")[1].split("/>")[0].split(" "),rangout=[];for(let t=0;t<rang.length;t++){const e=rang[t].split("=");prop=e[0].toLowerCase(),config=e[1].replaceAll('"',""),"begin"===prop?rangout[0]=parseFloat(config):"end"===prop&&(rangout[1]=parseFloat(config))}void 0!==l.ranges[l.ranges.length-1]&&1===l.ranges[l.ranges.length-1].length&&l.ranges[l.ranges.length-1].push(rangout[0]),l.ranges.push(rangout),l.subtitles.push(n[1].split("<br>"))}l.count=l.subtitles.length,this.subs.push(l)},parseITT:function(t,e,s){var i=t.split("<body>")[1].split("</body>")[0].split("<p "),n=null,l={movie:s,title:e,meta:{},ranges:[],subtitles:[],count:null,text:t,type:"itt"},a=null,r=null;for(let t=0;t<i.length;t++){if("b"!==i[t][0])continue;const e=i[t].split(">");a=e[0].split('"'),(n=[this.convertToTime(a[1]),this.convertToTime(a[3])])[1]+=n[0],e.shift();var o="";for(let t=0;t<e.length;t++){r=e[t].replaceAll("<br","\n");for(let t=0;t<r.length&&(r[t]+r[t+1]+r[t+2]+r[t+3]+r[t+4]!=="<span"&&r[t]+r[t+1]!=="</");t++)o+=r[t]}o=o.split("\n"),l.ranges.push(n),l.subtitles.push(o)}l.count=l.subtitles.length,this.subs.push(l)},parseUSF:function(e,s,i){var n=e.split("<metadata>")[1].split("</metadata>")[0],l=e.split("<subtitles>")[1].split("</subtitles>")[0].split("<subtitle "),a={movie:i,title:s,ranges:[],meta:{},subtitles:[],count:null,text:e,type:"usf"},r="",o="",h=!1,u=[null,null];if(-1!==n.indexOf("<title>")&&(a.meta.title=n.split("<title>")[1].split("</title>")[0]),-1!==n.indexOf("<date>")&&(a.meta.date=n.split("<date>")[1].split("</date>")[0]),-1!==n.indexOf("<author>")){var p=n.split("<author>")[1].split("</author>")[0];-1!==p.indexOf("<name>")&&(a.meta.authorName=p.split("<name>")[1].split("</name>")[0]),-1!==p.indexOf("<url>")&&(a.meta.authorUrl=p.split("<url>")[1].split("</url>")[0]),-1!==p.indexOf("<email>")&&(a.meta.authorEmail=p.split("<email>")[1].split("</email>")[0])}-1!==n.indexOf("<language")&&(a.meta.language="",t=n.split("<language ")[1].split("</language>")[0],a.meta.language=t.substr(t.indexOf(">")+1,t.length));for(let t=0;t<l.length;t++){if("s"!==l[t][0])continue;const e=l[t],s=l[t].split(">")[0].split('"');var c=this.convertToTime(s[1]),g=this.convertToTime(s[3]);-1!==e.indexOf("<text ")?(u[0]="<text ",u[1]="</text>"):-1!==e.indexOf("<karaoke ")&&(u[0]="<karaoke ",u[1]="</karaoke>"),r="",h=!1;for(let t=(o=e.split(u[0])[1].split(u[1])[0]).indexOf(">");t<o.length;t++){const e=o[t];"<"===o[t]&&" "!==o[t+1]&&(h=!1),h&&(r+=e),">"===e&&(h=!0)}var f=a.ranges.findIndex((t=>c>=t[0]&&c<=t[1]));-1!==f?a.subtitles[f]=a.subtitles[f].concat(r.split("\n")):(a.subtitles.push(r.split("\n")),a.ranges.push([c,g]))}a.count=a.subtitles.length,this.subs.push(a)},parseSUBTI:function(t,e,s){var i=t.split("=="),n={movie:s,title:e,meta:{},ranges:[],subtitles:[],count:null,text:t,type:"subti"},l=i[0].split("\n");l.pop();for(let t=0;t<l.length;t++){const e=l[t].split("=");n.meta[e[0]]=e[1]}n.meta.names=[];for(let t=1;t<i.length;t++){const e=i[t].split("\n");n.meta.names.push(e[0]),e.shift(),n.ranges.push(this.getSeconds(e[0])),e.shift(),""===e[e.length-1]&&e.pop(),n.subtitles.push(e)}n.count=n.subtitles.length,this.subs.push(n)},parseLRC:function(t,s,i){var n=t.split("\n"),l={movie:i,title:s,meta:{},ranges:[],subtitles:[],count:null,text:t,type:"lrc"};for(let t=0;t<n.length;t++){if(1===n[t].length||0===n[t].length)continue;const s=n[t].split("[")[1].split("]");var a=s[0],r=s[1];-1===e.indexOf(a[0])?(subj=a.substr(0,a.indexOf(":")),elm=a.substr(a.indexOf(":")+1,a.length),"au"===subj&&(subj="author"),"ar"===subj&&(subj="artist"),"al"===subj&&(subj="album"),"ti"===subj&&(subj="title"),l.meta[subj]=elm):(rang=this.convertToTime(a),k=l.ranges.push([rang]),l.subtitles.push([r]),void 0!==l.ranges[k-2]&&l.ranges[k-2].push(rang))}l.ranges[l.ranges.length-1].push(1/0),l.count=l.subtitles.length,this.subs.push(l)},convertToText:function(t,e=":",s="."){var i=Math.floor(t/3600);t-=3600*i;var n=Math.floor(t/60),l=(t-=60*n).toFixed(2);return i+e+n+e+(l=l.replace(".",s))},convertToTime:function(t){var e,s,i,n=0,l=t.split(":");return 3===l.length?(l[2]=l[2].replace(",","."),e=parseFloat(l[0]),s=parseFloat(l[1]),i=parseFloat(l[2])):(l[1]=l[1].replace(",","."),e=0,s=parseFloat(l[0]),i=parseFloat(l[1])),n+=3600*e+60*s+i},getSeconds:function(t){var e=[0,0];return t=-1!==t.indexOf("=>")?t.split("=>"):-1===t.indexOf("--\x3e")?t.split(","):t.split("--\x3e"),e[0]=this.convertToTime(t[0]),e[1]=this.convertToTime(t[1]),e},update:function(){if(null!==this.mode){if(0!==this.ranges.length&&0!==this.subtitles.length&&!1!==this.activated){current=this.video.currentTime*this.speedFactor,mov=this.video.src;for(let t=0;t<this.ranges.length;t++){const e=this.ranges[t],s=this.subtitles[t];if(current-=this.offset,current>=e[0]&&current<=e[1])if(this.current=t,1===this.mode)this.container.innerText=this.subtitles[this.current];else{family=this.style.family||"Arial",style=this.style.style||"normal",variant=this.style.variant||"normal",base=this.style.base||90,left=this.style.left||50,size=this.style.size||25,align=this.style.align||"center",color=this.style.color||"white",bg=this.style.bg||"rgba(0,0,0,0)",direction=this.style.direction||"ltr",opacity=this.style.opacity||1,weight=this.style.weight||"bold",marginL=this.style.marginLeft,marginT=this.style.marginTop,outlineColor=this.style.outlineColor||"black",outlineSize=this.style.outlineSize||1,shadowColor=this.style.shadowColor||"rgba(0,0,0,0)",shadowX=this.style.shadowX||0,shadowY=this.style.shadowY||0,shadowBlur=this.style.shadowBlur||0,lineSpacing=this.style.lineSpacing||0,lineHeight=this.style.lineHeight,this.renderer.beginPath(),x=this.renderer.canvas.width/100*left,y=this.renderer.canvas.height/100*base,this.renderer.fillStyle=color,this.renderer.textAlign=align,this.renderer.direction=direction,this.renderer.font=`${style} ${variant} ${weight} ${size}px ${family}`,this.renderer.shadowColor=shadowColor,this.renderer.shadowBlur=shadowBlur,this.renderer.shadowOffsetX=shadowX,this.renderer.shadowOffsetY=shadowY,this.renderer.globalAlpha=opacity;for(let t=s.length-1;t>-1;t--){const e=s[t];this.renderer.strokeStyle=outlineColor,this.renderer.lineWidth=2*outlineSize,this.renderer.strokeText(e,x,y),this.renderer.lineWidth=1,this.renderer.fillText(e,x,y),y-=lineHeight+lineSpacing}this.renderer.closePath()}}}}else console.warn("Must set up the parser rendering mode first!`Subtity.setUp2D or Subtity.setUpContainer`")},setUp2D:function(t,e){this.renderer=t instanceof CanvasRenderingContext2D?t:t.getContext("2d"),this.mode=2,this.video=e},setUpContainer:function(t,e){this.container=t,this.mode=1,this.video=e},setOffset:function(t){this.offset="number"!=typeof t||isNaN(t)?this.offset:t},setSpeed:function(t){this.speedFactor="number"!=typeof t||isNaN(t)?this.speedFactor:t},set:function(t,e){switch(t){case"family":this.style.family=e,this.calcFontHeight();break;case"color":this.style.color=e;break;case"weight":this.style.weight=e;break;case"style":this.style.style=e;break;case"variant":this.style.variant=e;break;case"size":this.style.size=parseFloat(e),this.calcFontHeight();break;case"align":this.style.align=e;break;case"direction":this.style.direction=e;break;case"shawX":this.style.shadowX=parseFloat(e);break;case"shawY":this.style.shadowY=parseFloat(e);break;case"shawBlur":this.style.shadowBlur=e;break;case"shawColor":this.style.shadowColor=e;break;case"bg":this.style.bg=e;break;case"outlineColor":this.style.outlineColor=e;break;case"outlineSize":this.style.outlineSize=parseFloat(e);break;case"lineSpacing":this.style.lineSpacing=parseFloat(e);break;case"base":this.style.base=parseFloat(e);break;case"left":this.style.left=parseFloat(e);break;case"opacity":this.style.opacity=isNaN(parseFloat(e))?1:parseFloat(e)}},calcFontHeight:function(){fontSize=parseFloat(this.style.size),fontFamily=this.style.family;var t=this.ctx;t.canvas.width=t.canvas.width,t.fillRect(0,0,t.canvas.width,t.canvas.height),t.textBaseline="top",t.font=fontSize+"px "+fontFamily,t.fillStyle="white",t.fillText("gM",0,0);for(var e=t.getImageData(0,0,t.canvas.width,t.canvas.height).data,s=-1,i=-1,n=0;n<t.canvas.height;n++)for(var l=0;l<t.canvas.width;l++){if(0!==e[4*(n*t.canvas.width+l)]){-1===s&&(s=n);break}if(l===t.canvas.width-1&&-1!==s){i=n,n=t.canvas.height;break}}this.style.lineHeight=i-s},loadDefaultStyle:function(){this.style={family:"Arial",size:19,lineSpacing:10,color:"rgb(255,255,255)",align:"center",direction:"ltr",outlineColor:"rgb(0,0,0)",outlineSize:1,shadowColor:"rgba(0,0,0,0)",opacity:1,shadowBlur:0,shadowX:0,shadowY:0,base:90,left:50,weight:"",style:"normal",variant:"normal"}},toggleActivation:function(t){return this.activated="boolean"==typeof t?t:!this.activated,this.activated},remove:function(t){var e=this.subs.findIndex((e=>e.title===t));return-1!==e&&(!0===this.subs[e].used&&this.reset(),this.subs.splice(e,1))},add:function(t,e,s,i){"string"==typeof s&&"string"==typeof e&&""!==t&&(!1!==this.check(t)&&(".srt"===(s=s.toLowerCase())||"srt"===s?this.parseSRT(e,t,i):".sbv"===s||"sbv"===s?this.parseSBV(e,t,i):".itt"===s||"itt"===s?this.parseITT(e,t,i):".webvtt"===s||"webvtt"===s?this.parseWEBVTT(e,t,i):".ssa"===s||"ssa"===s?this.parseSSA(e,t,i):".usf"===s||"usf"===s?this.parseUSF(e,t,i):".lrc"===s||"lrc"===s?this.parseLRC(e,t,i):".subti"===s||"subti"===s?this.parseSUBTI(e,t,i):".rt"===s||"rt"===s?this.parseRT(e,t,i):".dfxp"===s||"dfxp"===s||"ttml"===s||".ttml"===s?this.parseXMLBased(e,t,i):".xml"!==s&&"xml"!==s||this.parseXML(e,t,i)))},export:function(t){if("string"==typeof t){var e=!1;return".srt"===(t=t.toLowerCase())||"srt"===t?e=this.exportToSRT():".sbv"===t||"sbv"===t||".itt"===t||"itt"===t||(".webvtt"===t||"webvtt"===t?e=this.exportToWEBVTT():".ssa"===t||"ssa"===t?e=this.exportToSSA():".usf"===t||"usf"===t||(".lrc"===t||"lrc"===t?e=this.exportToLRC():".subti"!==t&&"subti"!==t||(e=this.exportToSUBTI()))),e}},check:function(t){return-1===this.subs.findIndex((e=>e.title===t))||(console.warn("The given title( "+t+") is already under use, please use a new one"),!1)},exportToSRT:function(){var t="";for(let s=0;s<this.subtitles.length;s++){const i=this.subtitles[s],n=this.ranges[s];var e=s+1+"\n";e+=this.convertToText(n[0],":",",")+" --\x3e "+this.convertToText(n[1],":",",")+"\n",t+=(e+=i.join("\n"))+"\n"}return t},exportToWEBVTT:function(){var t="WEBVTT\n";for(let s=0;s<this.subtitles.length;s++){const i=this.subtitles[s],n=this.ranges[s];var e=s+1+"\n";e+=this.convertToText(n[0])+" --\x3e "+this.convertToText(n[1])+"\n",t+=(e+=i.join("\n"))+"\n"}return t},exportToSUBTI:function(){var t="";for(const e in this.meta)if(this.meta.hasOwnProperty(e)){const i=this.meta[e];s=e+" = "+i+"\n",t+=s}t+="==";var e=void 0!==this.meta.names?this.meta.names:[];for(let s=0;s<this.subtitles.length;s++){const n=this.subtitles[s],l=this.ranges[s];var i=(void 0!==e[s]?e[s]:"")+"\n";i+=this.convertToText(l[0])+"=>"+this.convertToText(l[1])+"\n",t+=(i+=n.join("\n"))+"\n=="}return t},exportToLRC:function(){var t="";for(const e in this.meta)if(this.meta.hasOwnProperty(e)){const s=this.meta[e];name="artist"===e?"ar":"album"===e?"al":"title"===e?"ti":"author"===e?"au":e,t+="["+name+":"+s+"]\n"}for(let e=0;e<this.subtitles.length;e++){const s=this.subtitles[e][0];t+="["+this.convertToText(this.ranges[e][0])+"]"+s+"\n"}return t},exportToSSA:function(){text="[Script Info]\n";for(const t in this.meta)if(this.meta.hasOwnProperty(t)){const e=this.meta[t];text+=t+": "+e+"\n"}text+="\n",text+="[Events]\n",text+="Format: Start, End, Name, Text\n";var t=void 0!==this.meta.names?this.meta.names:[];for(let e=0;e<this.subtitles.length;e++){const s=this.subtitles[e],i=this.convertToText(this.ranges[e][0]),n=this.convertToText(this.ranges[e][1]),l=void 0!==t[e]?t[e]:"Unknown";text+="Dialogue: "+i+","+n+","+l+","+s+"\n"}return text},switchToLang:function(t){void 0!==this.meta.langs&&this.meta.langs.hasOwnProperty(t)&&(this.subtitles=this.meta.langs[t])}},i}));
//# sourceMappingURL=subtity.umd.min.js.map
