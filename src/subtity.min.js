let nums=["0","1","2","3","4","5","6","7","8","9"];class Subtity{subs=[];title="";text="";subtitles=[];ranges=[];current=0;subtitlesCounts=null;offset=0;style={family:"Arial",size:19,style:"normal",lineSpacing:5,variant:"normal",color:"rgb(255,255,255)",align:"center",direction:"ltr",outlineColor:"rgb(0,0,0)",outlineSize:1,shadowColor:"rgba(0,0,0,0)",opacity:1,shadowBlur:0,shadowX:0,shadowY:0,base:90,left:50,weight:""};renderer=null;container=null;meta={};mode=null;video=null;ctx=document.createElement("canvas").getContext("2d");activated=!1;currentFileType=null;speedFactor=1;constructor(){}reset(){this.current=0,this.speedFactor=1,this.offset=0,this.style={family:"Arial",size:19,style:"normal",variant:"normal",lineSpacing:10,color:"rgb(255,255,255)",align:"center",direction:"ltr",outlineColor:"rgb(0,0,0)",outlineSize:1,shadowColor:"rgba(0,0,0,0)",shadowBlur:0,opacity:1,shadowX:0,shadowY:0,base:90,left:50,weight:""},this.subtitles=[],this.ranges=[],this.activated=!1,this.subtitlesCounts=0,this.meta={},this.title="",this.currentFileType=null}use(t){let e=this.subs.findIndex((e=>e.title===t));if(-1!==e){if(""!==this.title){let t=this.subs.findIndex((t=>t.title===this.title));this.subs[t].used=!1}this.current=0,this.reset(),this.subs[e].used=!0,this.title=this.subs[e].title,this.ranges=this.subs[e].ranges,this.subtitles=this.subs[e].subtitles,this.text=this.subs[e].text,this.subtitlesCounts=this.subs[e].count,this.activated=!0,this.meta=this.subs[e].meta,this.currentFileType=this.subs[e].type,this.calcFontHeight()}}parseSRT(t,e,s){let i=t.split("\n"),l={movie:s,title:e,ranges:[],meta:{},subtitles:[],text:t,count:0,type:"srt"},n=!1,a=[];for(let t=0;t<i.length;t++){const e=i[t];1!=e.length&&0!==e.length||0===a.length||(n=!1,l.subtitles.push(a),a=[]),-1!==e.indexOf("--\x3e")?(l.ranges.push(this.getSeconds(e)),n=!0):!0===n&&1!==e.length&&a.push(e)}l.count=l.subtitles.length,this.subs.push(l)}parseXMLBased(t,e,s){let i=t.split("<body>")[1].split("</body>")[0].split("</div>"),l={movie:s,title:e,meta:{langs:{}},ranges:[],subtitles:[],text:t,type:"dfxp"},n=null,a=null,r=null,o=null;for(let t=0;t<i.length;t++){const e=i[t].split("<div ")[1];if(void 0===e)continue;let s=e.substring(0,e.indexOf(">")).split(" ");s.forEach(((t,e)=>{s[e]=s[e].split("="),"xml:lang"===s[e][0]&&(n=s[e][1].replaceAll('"',""),null===r&&(r=n),l.meta.langs[n]=[])}));let h=e.split("</p>");null===n&&(n="en",null===r&&(r=n));for(let e=0;e<h.length;e++){let s=h[e].split("<p ")[1];void 0!==s&&(s=s.substring(s.indexOf(">")+1,s.length),0===t&&(a=s.substring(0,s.indexOf(">")).split(" "),o=[],a.forEach(((t,e)=>{a[e]=a[e].split("="),"begin"===a[e][0]?o[0]=this.convertToTime(a[e][1].replaceAll('"',"")):"end"===a[e][0]&&(o[1]=this.convertToTime(a[e][1].replaceAll('"',"")))}))),l.ranges.push(o),l.meta.langs[n].push(s.split("<br />")))}}l.subtitles=l.meta.langs[r],l.count=l.subtitles.length,this.subs.push(l)}parseXML(t,e,s){let i=t.split("<video>")[1].split("<video/>")[0].split("</title>"),l={movie:s,title:e,meta:{},ranges:[],subtitles:[],text:t,type:"xml"};i.pop();for(let t=0;t<i.length;t++){const e=i[t].split("<title>")[1];rang0=this.convertToTime(e.split("<start>")[1].split("</start>")[0].replace(";",".")),rang1=this.convertToTime(e.split("<end>")[1].split("</end>")[0].replace(";",".")),rang=[rang0,rang1],l.ranges.push(rang),subtitle=e.split("<text>")[1].split("</text>")[0].split("<br/>"),l.subtitles.push(subtitle)}l.count=l.subtitles.length,this.subs.push(l)}parseWEBVTT(t,e,s){let i=t.split("\n"),l=!1,n={movie:s,title:e,meta:{},ranges:[],subtitles:[],text:t,type:"webvtt"},a=[];for(let t=0;t<i.length;t++){const e=i[t];if(-1===e.indexOf("NOTE ")&&-1===e[0].indexOf("NOTE\n"))if(!l||1===e.length&&0===e.length||a.push(e),-1!==e.indexOf("--\x3e")){let t=this.getSeconds(e);n.ranges.push(t),l=!0}else 1!==e.length&&0!==e.length||!0!==l||(l=!1,n.subtitles.push(a),a=[])}n.count=n.subtitles.length,this.subs.push(n)}parseSBV(t,e,s){let i=t.split("\n"),l=!1,n=!1,a=-1,r={movie:s,title:e,meta:{},ranges:[],subtitles:[],text:t,type:"sbv"};1!==i[0].length&&0!==i[0].length||(l=!0);for(let t=0;t<i.length;t++){let e=i[t];!0===n&&1!==e.length&&0!==e.length&&r.subtitles[a].push(e),!0===l&&(r.ranges.push(this.getSeconds(e)),l=!1,n=!0,a++,r.subtitles[a]=[]),1!==e.length&&0!==e.length||(l=!0,n=!1)}r.count=r.subtitles.length,this.subs.push(r)}parseSSA(t,e,s){let i=t.split("\n"),l=null,n={movie:s,title:e,meta:{},ranges:[],subtitles:[],count:null,text:t,type:"ssa"};for(let t=0;t<i.length;t++){const e=i[t];let s;if("["===e[0])s=e.substring(1,e.indexOf("]")-1).toLowerCase();else if("events"===s){let t=e.split(":");if(t.length>2){for(let e=2;e<t.length;e++)t[1]+=":"+t[e];t.splice(2,t.length)}let s=t[0].toLowerCase(),i=t[1];if("format"===s)l=i.toLowerCase().split(",");else if("dialogue"===s){let t=i.split(",");k=l.findIndex((t=>"text"===t.trim()));let e=t[k];i0=l.findIndex((t=>"start"===t.toLowerCase().trim())),i1=l.findIndex((t=>"end"===t.toLowerCase().trim())),t1=this.convertToTime(t[i0]),t2=this.convertToTime(t[i1]),n.ranges.push([t1,t2]),n.subtitles.push([e])}}else if("script info"===s){if(";"===e[0])continue;pieces=e.split(":"),lineSubject=pieces[0],n.meta[lineSubject]=pieces[1]}}n.count=n.subtitles.length,this.subs.push(n)}parseRT(t,e,s){let i=t.split("<br/>"),l=[],n={movie:s,title:e,meta:{},ranges:[],subtitles:[],count:null,text:t,type:"rt"};i.shift(),i[i.length-1]=i[i.length-1].split("</font>")[0];for(let t=0;t<i.length;t++){l=i[t].split("<clear/>"),rang=l[0].split("<time ")[1].split("/>")[0].split(" "),rangout=[];for(let t=0;t<rang.length;t++){const e=rang[t].split("=");prop=e[0].toLowerCase(),config=e[1].replaceAll('"',""),"begin"===prop?rangout[0]=parseFloat(config):"end"===prop&&(rangout[1]=parseFloat(config))}void 0!==n.ranges[n.ranges.length-1]&&1===n.ranges[n.ranges.length-1].length&&n.ranges[n.ranges.length-1].push(rangout[0]),n.ranges.push(rangout),n.subtitles.push(l[1].split("<br>"))}n.count=n.subtitles.length,this.subs.push(n)}parseITT(t,e,s){let i=t.split("<body>")[1].split("</body>")[0].split("<p "),l=null,n={movie:s,title:e,meta:{},ranges:[],subtitles:[],count:null,text:t,type:"itt"},a=null,r=null;for(let t=0;t<i.length;t++){if("b"!==i[t][0])continue;const e=i[t].split(">");a=e[0].split('"'),l=[this.convertToTime(a[1]),this.convertToTime(a[3])],l[1]+=l[0],e.shift();let s="";for(let t=0;t<e.length;t++){r=e[t].replaceAll("<br","\n");for(let t=0;t<r.length&&(r[t]+r[t+1]+r[t+2]+r[t+3]+r[t+4]!=="<span"&&r[t]+r[t+1]!=="</");t++)s+=r[t]}s=s.split("\n"),n.ranges.push(l),n.subtitles.push(s)}n.count=n.subtitles.length,this.subs.push(n)}parseUSF(e,s,i){let l=e.split("<metadata>")[1].split("</metadata>")[0],n=e.split("<subtitles>")[1].split("</subtitles>")[0].split("<subtitle "),a={movie:i,title:s,ranges:[],meta:{},subtitles:[],count:null,text:e,type:"usf"},r="",o="",h=!1,u=[null,null];if(-1!==l.indexOf("<title>")&&(a.meta.title=l.split("<title>")[1].split("</title>")[0]),-1!==l.indexOf("<date>")&&(a.meta.date=l.split("<date>")[1].split("</date>")[0]),-1!==l.indexOf("<author>")){let t=l.split("<author>")[1].split("</author>")[0];-1!==t.indexOf("<name>")&&(a.meta.authorName=t.split("<name>")[1].split("</name>")[0]),-1!==t.indexOf("<url>")&&(a.meta.authorUrl=t.split("<url>")[1].split("</url>")[0]),-1!==t.indexOf("<email>")&&(a.meta.authorEmail=t.split("<email>")[1].split("</email>")[0])}-1!==l.indexOf("<language")&&(a.meta.language="",t=l.split("<language ")[1].split("</language>")[0],a.meta.language=t.substring(t.indexOf(">")+1,t.length));for(let t=0;t<n.length;t++){if("s"!==n[t][0])continue;const e=n[t],s=n[t].split(">")[0].split('"');let i=this.convertToTime(s[1]),l=this.convertToTime(s[3]);-1!==e.indexOf("<text ")?(u[0]="<text ",u[1]="</text>"):-1!==e.indexOf("<karaoke ")&&(u[0]="<karaoke ",u[1]="</karaoke>"),o=e.split(u[0])[1].split(u[1])[0],r="",h=!1;for(let t=o.indexOf(">");t<o.length;t++){const e=o[t];"<"===o[t]&&" "!==o[t+1]&&(h=!1),h&&(r+=e),">"===e&&(h=!0)}let p=a.ranges.findIndex((t=>i>=t[0]&&i<=t[1]));-1!==p?a.subtitles[p]=a.subtitles[p].concat(r.split("\n")):(a.subtitles.push(r.split("\n")),a.ranges.push([i,l]))}a.count=a.subtitles.length,this.subs.push(a)}parseSUBTI(t,e,s){let i=t.split("=="),l={movie:s,title:e,meta:{},ranges:[],subtitles:[],count:null,text:t,type:"subti"},n=i[0].split("\n");n.pop();for(let t=0;t<n.length;t++){const e=n[t].split("=");l.meta[e[0]]=e[1]}l.meta.names=[];for(let t=1;t<i.length;t++){const e=i[t].split("\n");l.meta.names.push(e[0]),e.shift(),l.ranges.push(this.getSeconds(e[0])),e.shift(),""===e[e.length-1]&&e.pop(),l.subtitles.push(e)}l.count=l.subtitles.length,this.subs.push(l)}parseLRC(t,e,s){let i=t.split("\n"),l={movie:s,title:e,meta:{},ranges:[],subtitles:[],count:null,text:t,type:"lrc"};for(let t=0;t<i.length;t++){if(1===i[t].length||0===i[t].length)continue;const e=i[t].split("[")[1].split("]");let s=e[0],n=e[1];-1===nums.indexOf(s[0])?(subj=s.substring(0,s.indexOf(":")),elm=s.substring(s.indexOf(":")+1,s.length),"au"===subj&&(subj="author"),"ar"===subj&&(subj="artist"),"al"===subj&&(subj="album"),"ti"===subj&&(subj="title"),l.meta[subj]=elm):(rang=this.convertToTime(s),k=l.ranges.push([rang]),l.subtitles.push([n]),void 0!==l.ranges[k-2]&&l.ranges[k-2].push(rang))}l.ranges[l.ranges.length-1].push(1/0),l.count=l.subtitles.length,this.subs.push(l)}convertToText(t,e,s){e=e||":",s=s||".";let i=Math.floor(t/3600);t-=3600*i;let l=Math.floor(t/60),n=(t-=60*l).toFixed(2);return n=n.replace(".",s),i+e+l+e+n}convertToTime(t){let e,s,i,l=0,n=t.split(":");return 3===n.length?(n[2]=n[2].replace(",","."),e=parseFloat(n[0]),s=parseFloat(n[1]),i=parseFloat(n[2])):(n[1]=n[1].replace(",","."),e=0,s=parseFloat(n[0]),i=parseFloat(n[1])),l+=3600*e+60*s+i,l}getSeconds(t){let e=[0,0];return t=-1!==t.indexOf("=>")?t.split("=>"):-1===t.indexOf("--\x3e")?t.split(","):t.split("--\x3e"),e[0]=this.convertToTime(t[0]),e[1]=this.convertToTime(t[1]),e}update(){if(null===this.mode)return console.warn("Must set up the parser rendering mode first!`Subtity.setUp2D or Subtity.setUpContainer`");if(0===this.ranges.length||0===this.subtitles.length||!1===this.activated)return;let t=this.video.currentTime*this.speedFactor;this.video.src;for(let e=0;e<this.ranges.length;e++){const s=this.ranges[e],i=this.subtitles[e];if(t-=this.offset,t>=s[0]&&t<=s[1])if(this.current=e,1===this.mode)this.container.innerText=this.subtitles[this.current];else{let t=this.style.family||"Arial",e=this.style.style||"normal",s=this.style.variant||"normal",l=this.style.base||90,n=this.style.left||50,a=this.style.size||25,r=this.style.align||"center",o=this.style.color||"white",h=(this.style.bg,this.style.direction||"ltr"),u=this.style.opacity||1,p=this.style.weight||"bold",g=(this.style.marginLeft,this.style.marginTop,this.style.outlineColor||"black"),c=this.style.outlineSize||1,b=this.style.shadowColor||"rgba(0,0,0,0)",d=this.style.shadowX||0,f=this.style.shadowY||0,m=this.style.shadowBlur||0,x=this.style.lineSpacing||0,y=this.style.lineHeight;this.renderer.beginPath();let v=this.renderer.canvas.width/100*n,T=this.renderer.canvas.height/100*l;this.renderer.fillStyle=o,this.renderer.textAlign=r,this.renderer.direction=h,this.renderer.font=`${e} ${s} ${p} ${a}px ${t}`,this.renderer.shadowColor=b,this.renderer.shadowBlur=m,this.renderer.shadowOffsetX=d,this.renderer.shadowOffsetY=f,this.renderer.globalAlpha=u;for(let t=i.length-1;t>-1;t--){const e=i[t];this.renderer.strokeStyle=g,this.renderer.lineWidth=2*c,this.renderer.strokeText(e,v,T),this.renderer.lineWidth=1,this.renderer.fillText(e,v,T),T-=y+x}this.renderer.closePath()}}}setUp2D(t,e){this.renderer=t instanceof CanvasRenderingContext2D?t:t.getContext("2d"),this.mode=2,this.video=e}setUpContainer(t,e){this.container=t,this.mode=1,this.video=e}setOffset(t){this.offset="number"!=typeof t||isNaN(t)?this.offset:t}setSpeed(t){this.speedFactor="number"!=typeof t||isNaN(t)?this.speedFactor:t}set(t,e){switch(t){case"family":this.style.family=e,this.calcFontHeight();break;case"color":this.style.color=e;break;case"weight":this.style.weight=e;break;case"style":this.style.style=e;break;case"variant":this.style.variant=e;break;case"size":this.style.size=parseFloat(e),this.calcFontHeight();break;case"align":this.style.align=e;break;case"direction":this.style.direction=e;break;case"shawX":this.style.shadowX=parseFloat(e);break;case"shawY":this.style.shadowY=parseFloat(e);break;case"shawBlur":this.style.shadowBlur=e;break;case"shawColor":this.style.shadowColor=e;break;case"bg":this.style.bg=e;break;case"outlineColor":this.style.outlineColor=e;break;case"outlineSize":this.style.outlineSize=parseFloat(e);break;case"lineSpacing":this.style.lineSpacing=parseFloat(e);break;case"base":this.style.base=parseFloat(e);break;case"left":this.style.left=parseFloat(e);break;case"opacity":this.style.opacity=isNaN(parseFloat(e))?1:parseFloat(e)}}calcFontHeight(){let t=parseFloat(this.style.size),e=this.style.family,s=this.ctx;s.canvas.width=s.canvas.width,s.fillRect(0,0,s.canvas.width,s.canvas.height),s.textBaseline="top",s.font=t+"px "+e,s.fillStyle="white",s.fillText("gM",0,0);let i=s.getImageData(0,0,s.canvas.width,s.canvas.height).data,l=-1,n=-1;for(let t=0;t<s.canvas.height;t++)for(let e=0;e<s.canvas.width;e++){if(0!==i[4*(t*s.canvas.width+e)]){-1===l&&(l=t);break}if(e===s.canvas.width-1&&-1!==l){n=t,t=s.canvas.height;break}}this.style.lineHeight=n-l}loadDefaultStyle(){this.style={family:"Arial",size:19,lineSpacing:10,color:"rgb(255,255,255)",align:"center",direction:"ltr",outlineColor:"rgb(0,0,0)",outlineSize:1,shadowColor:"rgba(0,0,0,0)",opacity:1,shadowBlur:0,shadowX:0,shadowY:0,base:90,left:50,weight:"",style:"normal",variant:"normal"}}toggleActivation(t){return this.activated="boolean"==typeof t?t:!this.activated,this.activated}remove(t){let e=this.subs.findIndex((e=>e.title===t));return-1!==e&&(!0===this.subs[e].used&&this.reset(),this.subs.splice(e,1))}add(t,e,s,i){if("string"!=typeof s||"string"!=typeof e||""===t)return;!1!==this.check(t)&&(".srt"===(s=s.toLowerCase())||"srt"===s?this.parseSRT(e,t,i):".sbv"===s||"sbv"===s?this.parseSBV(e,t,i):".itt"===s||"itt"===s?this.parseITT(e,t,i):".webvtt"===s||"webvtt"===s?this.parseWEBVTT(e,t,i):".ssa"===s||"ssa"===s?this.parseSSA(e,t,i):".usf"===s||"usf"===s?this.parseUSF(e,t,i):".lrc"===s||"lrc"===s?this.parseLRC(e,t,i):".subti"===s||"subti"===s?this.parseSUBTI(e,t,i):".rt"===s||"rt"===s?this.parseRT(e,t,i):".dfxp"===s||"dfxp"===s||"ttml"===s||".ttml"===s?this.parseXMLBased(e,t,i):".xml"!==s&&"xml"!==s||this.parseXML(e,t,i))}export(t){if("string"!=typeof t)return;let e=!1;return".srt"===(t=t.toLowerCase())||"srt"===t?e=this.exportToSRT():".sbv"===t||"sbv"===t||".itt"===t||"itt"===t||(".webvtt"===t||"webvtt"===t?e=this.exportToWEBVTT():".ssa"===t||"ssa"===t?e=this.exportToSSA():".usf"===t||"usf"===t||(".lrc"===t||"lrc"===t?e=this.exportToLRC():".subti"!==t&&"subti"!==t||(e=this.exportToSUBTI()))),e}check(t){return-1===this.subs.findIndex((e=>e.title===t))||(console.warn("The given title( "+t+") is already under use, please use a new one"),!1)}exportToSRT(){let t="";for(let e=0;e<this.subtitles.length;e++){const s=this.subtitles[e],i=this.ranges[e];let l=e+1+"\n";l+=this.convertToText(i[0],":",",")+" --\x3e "+this.convertToText(i[1],":",",")+"\n",l+=s.join("\n"),t+=l+"\n"}return t}exportToWEBVTT(){let t="WEBVTT\n";for(let e=0;e<this.subtitles.length;e++){const s=this.subtitles[e],i=this.ranges[e];let l=e+1+"\n";l+=this.convertToText(i[0])+" --\x3e "+this.convertToText(i[1])+"\n",l+=s.join("\n"),t+=l+"\n"}return t}exportToSUBTI(){let t="";for(const e in this.meta)if(this.meta.hasOwnProperty(e)){const i=this.meta[e];s=e+" = "+i+"\n",t+=s}t+="==";let e=void 0!==this.meta.names?this.meta.names:[];for(let s=0;s<this.subtitles.length;s++){const i=this.subtitles[s],l=this.ranges[s];let n=(void 0!==e[s]?e[s]:"")+"\n";n+=this.convertToText(l[0])+"=>"+this.convertToText(l[1])+"\n",n+=i.join("\n"),t+=n+"\n=="}return t}exportToLRC(){let t="";for(const e in this.meta)if(this.meta.hasOwnProperty(e)){const s=this.meta[e];name="artist"===e?"ar":"album"===e?"al":"title"===e?"ti":"author"===e?"au":e,t+="["+name+":"+s+"]\n"}for(let e=0;e<this.subtitles.length;e++){const s=this.subtitles[e][0];t+="["+this.convertToText(this.ranges[e][0])+"]"+s+"\n"}return t}exportToSSA(){text="[Script Info]\n";for(const t in this.meta)if(this.meta.hasOwnProperty(t)){const e=this.meta[t];text+=t+": "+e+"\n"}text+="\n",text+="[Events]\n",text+="Format: Start, End, Name, Text\n";let t=void 0!==this.meta.names?this.meta.names:[];for(let e=0;e<this.subtitles.length;e++){const s=this.subtitles[e],i=this.convertToText(this.ranges[e][0]),l=this.convertToText(this.ranges[e][1]),n=void 0!==t[e]?t[e]:"Unknown";text+="Dialogue: "+i+","+l+","+n+","+s+"\n"}return text}switchToLang(t){void 0!==this.meta.langs&&this.meta.langs.hasOwnProperty(t)&&(this.subtitles=this.meta.langs[t])}}export default Subtity;